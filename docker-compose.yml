# version is obsolete in Docker Compose v2+ and triggers a warning
services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: aletheia-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-aletheia}
      POSTGRES_USER: ${POSTGRES_USER:-aletheia}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-local}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Optional: mount init scripts
      # - ./backend/src/main/resources/db/migration:/docker-entrypoint-initdb.d
    networks:
      - aletheia-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-aletheia}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aletheia-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-aletheia}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-aletheia}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-local}
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.PostgreSQLDialect
      # Always /app/ai.key in container (do not inherit ../ai.key from .env)
      AI_ALETHEIA_SIGNING_KEY_PATH: /app/ai.key
      AI_ALETHEIA_TSA_MODE: ${AI_ALETHEIA_TSA_MODE:-real}
      AI_ALETHEIA_TSA_URL: ${AI_ALETHEIA_TSA_URL:-http://timestamp.digicert.com}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
    volumes:
      - ./ai.key:/app/ai.key:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - aletheia-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # NEXT_PUBLIC_API_URL: empty = relative /api (ngrok); set for direct backend URL (see deploy/ansible/README.md).
      # BACKEND_INTERNAL_URL: used at build time only if rewrites were used; runtime proxy reads env at request time.
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
        BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8080}
    container_name: aletheia-frontend
    ports:
      - "3000:3000"
    # Runtime proxy (app/api/[...path]/route.ts) reads this to forward /api/* to the backend container.
    environment:
      BACKEND_INTERNAL_URL: http://backend:8080
    depends_on:
      - backend
    networks:
      - aletheia-network

  # Local RFC 3161 TSA (OpenTSA or custom)
  # Note: This is a placeholder. For actual implementation, use:
  # - OpenTSA Docker image
  # - Custom Java TSA service
  # - Or rely on MOCK_TSA for testing
  tsa:
    image: ghcr.io/digicert/timestamp-authority:latest
    container_name: aletheia-tsa
    ports:
      - "3180:3180"
    environment:
      TSA_PORT: 3180
      TSA_POLICY_OID: "1.2.3.4.5.6.7.8"
    networks:
      - aletheia-network
    # Note: If ghcr.io/digicert/timestamp-authority doesn't exist,
    # comment out this service and use MOCK_TSA in tests.
    # Alternatively, build your own TSA container.
    profiles:
      - with-tsa  # Only start with: docker-compose --profile with-tsa up

volumes:
  postgres_data:
    driver: local

networks:
  aletheia-network:
    driver: bridge

# ============================================
# Usage Instructions
# ============================================
#
# Full stack (PostgreSQL + backend + frontend):
#   1. Generate signing key: openssl genpkey -algorithm RSA -out ai.key -pkeyopt rsa_keygen_bits:2048
#   2. Create .env with OPENAI_API_KEY=sk-your-key (and optional overrides)
#   3. docker-compose up -d
#   Frontend: http://localhost:3000  |  Backend: http://localhost:8080
#
# PostgreSQL only (for local dev without containers):
#   docker-compose up -d postgres
#
# Start PostgreSQL + TSA:
#   docker-compose --profile with-tsa up -d
#
# Stop all services:
#   docker-compose down
#
# Stop and remove volumes:
#   docker-compose down -v
#
# View logs:
#   docker-compose logs -f postgres
#
# Check status:
#   docker-compose ps
#
# ============================================
# Environment Variables
# ============================================
# Override defaults by creating .env file:
#   POSTGRES_DB=aletheia
#   POSTGRES_USER=aletheia
#   POSTGRES_PASSWORD=secure_password_here
#
# See .env.example for full configuration template
