# Модель аудита агентов

**Доказуемое, проверяемое и объяснимое отслеживание поведения автономных и полуавтономных LLM-агентов.**

---

## Содержание

- [Назначение](#назначение)
- [Что такое действие агента](#что-такое-действие-агента)
- [Философия аудита](#философия-аудита)
- [Структура записи аудита](#структура-записи-аудита)
- [Что подписывается](#что-подписывается)
- [Криптографические гарантии](#криптографические-гарантии)
- [Граница ответственности](#граница-ответственности)
- [Человек в цикле](#человек-в-цикле)
- [Мультиагентные системы](#мультиагентные-системы)
- [Почему это важно](#почему-это-важно)
- [Пример объяснения инцидента](#пример-объяснения-инцидента)
- [Будущие расширения](#будущие-расширения)
- [Резюме](#резюме)
- [Связанные документы](#связанные-документы)

---

## Назначение

Этот документ описывает **модель аудита для автономных или полуавтономных LLM-агентов**.

Его цель — сделать поведение агентов **доказуемым, проверяемым и объяснимым постфактум**.

**Кратко:**

> Не «почему ИИ так подумал»,  
> а **что именно произошло, когда и при каких условиях**.

Эта модель предназначена для работы с криптографической подписью и временными метками, как реализовано в PoC Aletheia AI.

---

## Что такое действие агента

**Действие агента** — это любой выход, который может повлиять на реальный мир.

**Примеры:**

- Текстовая рекомендация
- Предложение решения
- Инструкция, сгенерированная для другой системы
- Предложение API-вызова
- План выполнения инструмента
- Сообщение, отправленное пользователю или другому агенту

**Важно:**

Даже если агент *не* выполняет действие сам, **само предложение может нести ответственность**.

Пример: Агент рекомендует медицинскую дозировку. Даже если человек должен одобрить её, сама рекомендация — это действие с потенциальными последствиями.

---

## Философия аудита

Система **не** пытается доказать, что ответ правильный.

Вместо этого она доказывает:

| Аспект | Что доказывается |
|--------|------------------|
| **Содержание** | Что произвёл агент |
| **Время** | Когда это было произведено |
| **Конфигурация** | При какой конфигурации (temperature, top_p и т.д.) |
| **Модель** | Какой моделью и какой версией |
| **Целостность** | Что это не было изменено позже |

**Это отражает принципы, используемые в:**

- Финансовых системах (журналы транзакций, audit trail)
- PKI (прозрачность сертификатов, временные метки подписей)
- Реагировании на инциденты (криминалистические доказательства)
- Чёрных ящиках самолётов (неизменяемые журналы событий)

**Цель:** Создать **неизменяемую запись о том, что произошло**, а не суждение о том, было ли это «правильно».

---

## Структура записи аудита

Каждое действие агента генерирует **неизменяемую запись аудита**.

### Минимальные поля

```json
{
  "agent_id": "logistics-agent-v1",
  "request_id": "uuid",
  "timestamp": "2026-01-31T16:15:00Z",
  "model": "gpt-4.1",
  "model_version": "gpt-4.1-turbo-2026-01-25",
  "prompt": "Рассчитай оптимальный маршрут для доставки...",
  "context": "Местоположение пользователя: Берлин, Направление: Мюнхен, ограничения: ...",
  "response": "Рекомендованный маршрут: A9 через Нюрнберг. Расчётное время прибытия: 4.5 часа.",
  "parameters": {
    "temperature": 0.2,
    "top_p": 0.9,
    "max_tokens": 500
  }
}
```

Эта структура называется **Agent Evidence Payload** (полезная нагрузка доказательств агента).

### Описание полей

| Поле | Описание | Обязательно |
|------|----------|-------------|
| `agent_id` | Уникальный идентификатор экземпляра агента | ✅ Да |
| `request_id` | Уникальный ID для этого запроса (для корреляции) | ✅ Да |
| `timestamp` | Временная метка UTC, когда был сгенерирован ответ | ✅ Да |
| `model` | Имя модели (например, "gpt-4.1", "gemini-pro") | ✅ Да |
| `model_version` | Точный идентификатор версии/снэпшота | ✅ Да |
| `prompt` | Входной промпт, отправленный модели | ✅ Да |
| `context` | Дополнительный контекст (история разговора, системный промпт и т.д.) | Рекомендуется |
| `response` | Выход, сгенерированный агентом | ✅ Да |
| `parameters` | Параметры модели (temperature, top_p, seed и т.д.) | ✅ Да |
| `tools_used` | Список использованных инструментов/API (если применимо) | Опционально |
| `metadata` | Дополнительные метаданные (user_id, session_id и т.д.) | Опционально |

---

## Что подписывается

Система создаёт **каноническое представление** полезной нагрузки аудита.

### Процесс

```
1. Канонизация payload (детерминированное JSON/текстовое представление)
2. hash = SHA-256(canonical_payload)
3. signature = Sign(hash, agent_private_key)
4. timestamp = RFC3161(signature)
```

**Рекомендуемый подход (из [пайплайна Aletheia](../../diagrams/architecture.md)):**

```
canonical_payload → hash → sign → timestamp(signature)
```

Это гарантирует, что и **содержание**, и **ответственность** заморожены во времени.

### Почему метить по времени подпись?

- **Целостность содержания:** Хеш доказывает, что payload не изменился.
- **Доказательство времени:** Временная метка доказывает, что подпись существовала в момент T.
- **Цепочка доверия:** TSA удостоверяет *когда*, ключ агента удостоверяет *что*.

См. [Модель доверия](TRUST_MODEL.md) для деталей о том, кто что удостоверяет.

---

## Криптографические гарантии

Запись аудита позволяет любому проверить:

| Гарантия | Что доказывается |
|----------|------------------|
| ✅ **Целостность содержания** | Содержание не изменилось с момента подписания |
| ✅ **Аутентификация** | Подпись принадлежит агенту/системе (через публичный ключ) |
| ✅ **Неотказуемость** | Агент не может отрицать генерацию этого выхода |
| ✅ **Доказательство времени** | Временная метка доказывает существование в момент T (через TSA) |
| ✅ **Хронологический порядок** | Запись предшествует любому инциденту или спору |

**Это создаёт неотказуемость для поведения ИИ.**

Любой, у кого есть:
- Запись аудита (payload + подпись + временная метка)
- Публичный ключ агента
- Публичный ключ/сертификат TSA

может независимо проверить все гарантии.

---

## Граница ответственности

**Важное уточнение:**

| Что означает подпись | Что она НЕ означает |
|----------------------|---------------------|
| ✅ Этот точный выход был сгенерирован этим агентом | ❌ Ответ правильный |
| ✅ В это конкретное время | ❌ Агент юридически ответственен |
| ✅ При этой конфигурации | ❌ Выход безопасен или уместен |
| ✅ Содержание не изменено | ❌ Решение следует выполнить |

**Подпись доказывает:**

> «Кто сгенерировал и представил выход».

**Она НЕ доказывает:**

> «Что выход правильный или ему следует доверять».

### Аналогия

Это похоже на:

- **Записи видеорегистратора** — доказывают, что произошло, а не кто виноват
- **Системные логи** — записывают события, а не корректность
- **DKIM-подписи email** — доказывают отправителя, а не валидность содержания
- **Нотариальное заверение** — удостоверяет подпись, а не истинность документа

### Пример утверждения

> «В момент T наша система получила этот точный выход от модели M и предоставила его пользователю без изменений. Мы не удостоверяем корректность выхода, но можем доказать, что это то, что было сгенерировано».

---

## Человек в цикле

Если человек одобряет или изменяет выход, это становится **новым событием аудита**.

### Пример потока

```
1. Агент генерирует выход → Запись аудита A (подписана + проштампована)
   ↓
2. Человек проверяет и изменяет → Запись аудита B (подписана + проштампована)
   ↓
3. Изменённый ответ отправлен пользователю → связан с A и B
```

### Запись аудита для действия человека

```json
{
  "action_type": "human_review",
  "reviewer_id": "user@example.com",
  "timestamp": "2026-01-31T16:20:00Z",
  "original_response_id": "uuid-from-record-A",
  "modified_response": "Обновлённая рекомендация на основе дополнительных ограничений...",
  "changes": "Добавлено ограничение X, удалено предложение Y",
  "approval_status": "approved_with_modifications"
}
```

**Каждый шаг должен произвести отдельную запись аудита.**

Это сохраняет полную прослеживаемость:
- Что изначально сказал агент?
- Что изменил человек?
- Когда произошло каждое действие?

---

## Мультиагентные системы

Для цепочек агентов (MCP, инструментальные агенты, планировщики, мультиагентные рабочие процессы):

**Каждый агент должен произвести свою собственную запись аудита.**

### Пример цепочки

```
Агент-планировщик → Запись аудита 1
   ↓
Инструментальный агент → Запись аудита 2
   ↓
Агент выполнения → Запись аудита 3
```

### Структура цепочки

```json
{
  "agent_id": "planner-agent",
  "request_id": "chain-uuid",
  "response": "План: Шаг 1...",
  "next_agent": "tool-agent",
  "chain_position": 1
}
```

```json
{
  "agent_id": "tool-agent",
  "request_id": "chain-uuid",
  "previous_agent": "planner-agent",
  "response": "Результат выполнения инструмента...",
  "chain_position": 2
}
```

### Преимущества

- **Реконструкция:** Полная временная линия рассуждений может быть восстановлена
- **Изоляция вины:** Определить, какой агент в цепочке вызвал проблему
- **Конфиденциальность:** Внутренняя цепь мыслей не раскрывается (только финальные выходы)
- **Гранулярный аудит:** Каждый шаг независимо проверяем

### Перекрёстные ссылки между агентами

Используйте `chain_id` или `parent_request_id` для связывания связанных записей аудита между агентами.

---

## Почему это важно

Эта модель становится **критичной**, когда:

| Сценарий | Риск без модели аудита |
|----------|------------------------|
| **Агенты работают непрерывно** | Нет записи о решениях, принятых ночью |
| **Агенты управляют инструментами** | Невозможно доказать, какие действия были фактически предприняты |
| **Агенты влияют на деньги, логистику, безопасность** | Ответственность неясна в случае ошибки |
| **Агенты дают советы уязвимым пользователям** | Невозможно проверить, что было на самом деле сказано |
| **Регуляторы спрашивают "кто это сказал и когда?"** | Нет криминалистических доказательств |

### Особенно актуальные случаи

- **Логистические ошибки** — неправильный маршрут, задержка доставки, повреждённые товары
- **Автоматизированное принятие решений** — одобрение кредита, страховые претензии, найм
- **Финансовые рекомендации** — инвестиционные советы, торговые решения
- **Модерация контента** — ложные положительные/отрицательные результаты, споры о цензуре
- **Безопасность детей** — неуместный контент, показанный несовершеннолетним
- **Рынки автономных агентов** — агент A вызывает агента B, кто ответственен?

### Реальный сценарий

**Вопрос:** «Почему агент рекомендовал эту рискованную инвестицию?»

**Без модели аудита:** «Мы не знаем, логи были перезаписаны».

**С моделью аудита:** «Вот точный промпт, версия модели, temperature и выход, криптографически запечатанный в временной метке T. Рекомендация была основана на контексте X».

---

## Пример объяснения инцидента

**Сценарий:** Агент рекомендует логистический маршрут, который вызывает задержку.

**Ответ с моделью аудита агентов:**

> «Эта рекомендация была сгенерирована **агентом logistics-agent-v1**  
> с использованием модели **gpt-4.1-turbo-2026-01-25**  
> в **2026-01-31 16:15:00 UTC**  
> и была криптографически запечатана в этот момент через подпись и RFC 3161 временную метку.  
>  
> Система не изменяла содержание впоследствии.  
>  
> Агент работал с temperature=0.2, при следующем контексте: [детали контекста].  
>  
> Вот подписанная запись аудита: [ссылка на портал проверки]».

**Это ИИ-эквивалент:**

> «Вот запись чёрного ящика».

### Портал проверки

Пользователи, регуляторы или аудиторы могут:
1. Скачать запись аудита (JSON)
2. Проверить подпись относительно публичного ключа агента
3. Проверить временную метку относительно сертификата TSA
4. Проинспектировать точный вход/выход/конфигурацию

Всё это без необходимости доверять слову Aletheia.

---

## Будущие расширения

Запланированные или совместимые расширения для усиленной аудируемости:

| Расширение | Преимущество |
|------------|--------------|
| **eIDAS-квалифицированный TSA** | Временные метки юридического уровня (регулирование ЕС) |
| **Квалифицированные сертификаты** | Ключи агентов, сертифицированные доверенным CA |
| **HSM-защищённые ключи агентов** | Аппаратная защита для приватных ключей агентов |
| **Сертификаты идентичности на агента** | Каждый агент имеет верифицируемую идентичность |
| **Публичный портал проверки** | Любой может проверить записи аудита онлайн |
| **Системы репутации агентов** | Отслеживание производительности агентов со временем |
| **Сжатие записей аудита** | Эффективное хранение миллионов записей |
| **Доказательства с нулевым разглашением** | Доказать свойства без раскрытия полной записи |

См. [Модель доверия (соответствие eIDAS)](TRUST_MODEL.md#eidas-соответствие-неквалифицированное--квалифицированное) для пути обновления до квалифицированных доверенных сервисов.

---

## Резюме

**AGENT_AUDIT_MODEL — не о доверии.**

Это о:

| Принцип | Описание |
|---------|----------|
| **Память** | Постоянная запись о том, что произошло |
| **Подотчётность** | Чёткий след того, кто что сделал |
| **Хронология** | Неопровержимые временные метки |
| **Доказательство** | Криптографическое подтверждение, а не просто логи |
| **Аудируемость** | Независимая верификация третьими сторонами |

### Финальное утверждение

> ИИ-системы будут совершать ошибки.  
>  
> Эта модель гарантирует, что когда они это сделают,  
> **истина о том, что произошло, не исчезнет.**

---

## Связанные документы

- [Подпись (SIGNING)](SIGNING.md) — Как подписываются выходы агентов (RSA PKCS#1 v1.5)
- [Временные метки (TIMESTAMPING)](TIMESTAMPING.md) — RFC 3161 временные метки для действий агентов
- [Модель доверия (TRUST_MODEL)](TRUST_MODEL.md) — Кто что удостоверяет, соответствие eIDAS
- [Криптографический оракул (CRYPTO_ORACLE)](CRYPTO_ORACLE.md) — Тестирование выходов агентов на воспроизводимость
- [MOCK_TSA (MOCK_TSA)](MOCK_TSA.md) — Детерминированный TSA для тестирования записей аудита агентов
- [Архитектурные диаграммы](../../diagrams/architecture.md) — Пайплайн: канонизация → хеш → подпись → временная метка
- [План имплементации (plan)](plan.md) — Дорожная карта задач для имплементации audit trail
- [README](../../README.md) — Обзор проекта, философия дизайна

---

**Статус:** Концептуальная модель. Имплементация запланирована для PoC и далее.

**Лицензия:** MIT (в соответствии с проектом Aletheia AI).
