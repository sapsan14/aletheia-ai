# Aletheia AI — Deploy workflow
# Runs on push to main or manual trigger. Jobs: test → build → deploy via Ansible.
#
# Required GitHub Secrets:
#   DEPLOY_HOST      — target VM IP or hostname (e.g. 193.40.157.132)
#   DEPLOY_USER      — SSH user (e.g. ubuntu)
#   SSH_PRIVATE_KEY  — SSH private key for deploy (content of ~/.ssh/id_ed25519 or id_rsa)
#   SIGNING_KEY      — PEM content of ai.key (cat ai.key; required for backend to start)
#
# Optional (for production):
#   POSTGRES_PASSWORD    — DB password (default: local)
#   OPENAI_API_KEY       — OpenAI API key
#   NEXT_PUBLIC_API_URL  — frontend API URL (e.g. http://YOUR_VM_IP:8080)

name: "Deploy"

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "diagrams/**"
      - "*.md"
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Backend tests
        run: mvn test -q
        working-directory: backend

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend build
        run: npm ci && npm run build
        working-directory: frontend

  build:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: backend
          push: false
          load: true
          tags: aletheia-backend:latest

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          push: false
          load: true
          tags: aletheia-frontend:latest

  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: [test, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for Ansible)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: pip install ansible

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup signing key
        run: |
          printf '%s\n' "$SIGNING_KEY" > /tmp/ci-ai.key
          chmod 600 /tmp/ci-ai.key
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}

      - name: Create Ansible inventory
        run: |
          cat > /tmp/deploy-inventory.yml << EOF
          all:
            children:
              deploy:
                hosts:
                  aletheia:
                    ansible_host: ${{ secrets.DEPLOY_HOST }}
                vars:
                  ansible_user: ${{ secrets.DEPLOY_USER }}
                  ansible_ssh_private_key_file: /tmp/deploy_key
          EOF

      - name: Deploy with Ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
        run: |
          EXTRA_ARGS="-e signing_key_src=/tmp/ci-ai.key"
          [ -n "${{ secrets.POSTGRES_PASSWORD }}" ] && EXTRA_ARGS="$EXTRA_ARGS -e postgres_password=${{ secrets.POSTGRES_PASSWORD }}"
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] && EXTRA_ARGS="$EXTRA_ARGS -e openai_api_key=${{ secrets.OPENAI_API_KEY }}"
          if [ -n "${{ secrets.NEXT_PUBLIC_API_URL }}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS -e next_public_api_url=${{ secrets.NEXT_PUBLIC_API_URL }}"
          else
            EXTRA_ARGS="$EXTRA_ARGS -e next_public_api_url=http://${{ secrets.DEPLOY_HOST }}:8080"
          fi
          ansible-playbook \
            -i /tmp/deploy-inventory.yml \
            deploy/ansible/playbook.yml \
            $EXTRA_ARGS
